<!--
    Task DOM for loading the S3 Images
    It uses the class="skeleton" to identify the elements that belong to the
    task.
-->
<div class="row skeleton">

    <div class="btn-group pull-right">
        <button class="btn btn-info btn-sm" data-toggle="modal" data-target="#myModal"><i
                class="glyphicon glyphicon-eye-open"></i> Tutorial
        </button>
        <a class="btn btn-info btn-sm" id="imgLink" target="_blank" data-toggle="tooltip" data-placement="top"
           title="Opens in a new window" href="http://community.micropasts.org/category/crowdsourcing-support"><i
                class="glyphicon glyphicon-book"></i> Community Help</a>
    </div>


    <div class="col-md-12"><!-- Start of Photo DIV (column) -->
        <div id="map"></div>
    </div>

    <div class="col-md-12">
       <div id="step1">
          <table class="table table-striped" id="wgsTranscribe">
              <tr>
                  <th>Number</th>
                  <th>Date</th>
                  <th>Details</th>
                  <th>Length</th>
                  <th>Width</th>
                  <th>Weight in lbs</th>
                  <th>Weight in oz</th>
              </tr>
              <tr>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
                  <td></td>
              </tr>
          </table>
          <button class="btn btn-submit" style="margin-top:5px;">Submit transcribed table!</button>
      </div>

    </div>
    <div class="col-md-12">
        <!-- Feedback items for the user -->

        <p>You are working now on task: <span id="task-id" class="label label-warning">#</span></p>

        <p>You have completed: <span id="done" class="label label-info"></span> tasks from
            <!-- Progress bar for the user -->
            <span id="total" class="label label-inverse"></span></p>

        <div class="progress progress-striped">
            <div id="progress" class="progress-bar" role="progressbar" rel="tooltip" title="#" class="bar"
                 style="width: 0%;"></div>
        </div>

        <div id="answer"> <!-- Start DIV for the submission buttons -->
        </div>
        <!-- End of DIV for the submission buttons -->
    </div>

    <div class="row">
        <!-- Success and Error Messages for the user -->
        <div class="col-md-6 col-md-offset-2" style="height:50px">
            <div id="success" class="alert alert-success" style="display:none;">
                <a class="close">Ã—</a>
                <strong>Well done!</strong> Your answer has been saved
            </div>
            <div id="loading" class="alert alert-info" style="display:none;">
                <a class="close">X</a>
                Loading next task...
            </div>
            <div id="taskcompleted" class="alert alert-info" style="display:none;">
                <strong>The task has been completed!</strong> Thanks a lot!
            </div>
            <div id="finish" class="alert alert-success" style="display:none;">
                <strong>Congratulations!</strong> You have participated in all available tasks!
                <br/>

                <div class="alert-actions">
                    <a class="btn small" href="/">Go back</a>
                    <a class="btn small" href="/app">or, Check other applications</a>
                </div>
            </div>
            <div id="error" class="alert alert-error" style="display:none;">
                <a class="close">X</a>
                <strong>Error!</strong> Something went wrong, please contact <a href="mailto:info@micropasts.org">MicroPasts
                team</a>
            </div>
        </div>
        <!-- End Success and Error Messages for the user -->
    </div>
    <!-- End of Row -->

    <!-- End of Question and Submission DIV (column) -->

</div><!-- End of Skeleton Row -->


<div id="survey" class="modal fade" data-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Do you want to help us?</h4>
            </div>
            <div class="modal-body">
                Thanks for contributing one task for the project. We are interested in knowing how you found out about
                us.
                <strong>Could you please answer two questions in a short survey?</strong>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Skip</button>
                <a class="btn btn-large btn-success"
                   href="https://docs.google.com/forms/d/1Kgw8cvcufm-77PC2t_PL_b4y1_Tb9wJseimmb3cQIn4/viewform?embedded=true">Of
                    course!
                    Take me to the survey!</a>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div><!-- /.modal -->

<div id="survey25" class="modal fade" data-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">Congrats for completing 25 tasks!</h4>
            </div>
            <div class="modal-body">
                Thanks for contributing 25 tasks for the project. Now that you have been using MicroPasts for a while,
                we would like to know how you found it. <strong>Could you please answer a few questions in a short
                survey?</strong>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Skip</button>
                <a class="btn btn-large btn-success"
                   href="https://docs.google.com/forms/d/1uczUGGYbrQ2FQfTtM8j4vfGr2qwcCMW6PLwzfvZZ6kI/viewform?embedded=true">Of
                    course! Take me to the survey!</a>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div><!-- /.modal -->

<!-- Modal start -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Modal header -->
            <div class="modal-header">
                <h3>Photo-masking tutorial for 3D modelling </h3>
            </div>

            <!-- Step 1 of the tutorial -->
            <div id="0" class="modal-body" style="display:none">
                <!-- Insert content for step 3 -->
            </div>

            <!-- Step 2 of the tutorial -->
            <div id="1" class="modal-body" style="display:none">
                <!-- Insert content for step 2 -->
            </div>

            <div id="2" class="modal-body" style="display:none">
                <!-- Insert content for step 3 -->
            </div>

            <!-- End of stepped modal body -->

            <!-- Modal footer -->
            <div class="modal-footer">
                <a id="prevBtn" href="#" onclick="showStep('prev')" class="btn btn-default">Previous</a>
                <a id="nextBtn" href="#" onclick="showStep('next')" class="btn btn-success">Next</a>
                <button id="startContrib" data-dismiss="modal" class="btn btn-primary" style="display:none"/>
                <i class="glyphicon glyphicon-thumbs-up"></i> Let's start!</a>
            </div>
        </div>
    </div>
</div>


<script src="https://code.jquery.com/ui/1.8.1/jquery-ui.min.js" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-handsontable/0.10.2/jquery.handsontable.min.js" type="text/javascript"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ol3/3.2.1/ol.css" type="text/css">
<link rel="stylesheet" href="/static/vendor/fancybox/jquery.fancybox.css?v=2.1.5" type="text/css" media="screen"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ol3/3.2.1/ol.min.js" type="text/javascript"></script>
<script src="/static/js/vendor/jquery.serializeJSON.min.js" type="text/javascript"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.0/jquery.cookie.min.js" type="text/javascript"></script>
<script src="/static/vendor/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>
<!-- Modal end -->
<script type="text/javascript">
    var step = -1;
    function showStep(action) {
        $("#" + step).hide();
        if (action == 'next') {
            step = step + 1;
        }
        if (action == 'prev') {
            step = step - 1;
        }
        if (step == 0) {
            $("#prevBtn").hide();
        }
        else {
            $("#prevBtn").show();
        }

        if (step == 2) {
            $("#nextBtn").hide();
            $("#startContrib").show();
        }
        $("#" + step).show();
    }

    showStep('next');
    $("#modal").modal('show');
    var handsontable = $("#wgsTranscribe").data('handsontable');
</script>
<script>
pybossa.taskLoaded(function(task, deferred) {
console.log(task.info);
    if ( !$.isEmptyObject(task) ) {
    // Map views always need a projection.  Here we just want to map image
    // coordinates directly to map coordinates, so we create a projection that uses
    // the image extent in pixels.
    var extent = [0, 0, 4000, 6016];
    var projection = new ol.proj.Projection({
      code: '',
      units: 'pixels',
      extent: extent
    });

    var map = new ol.Map({
      controls: ol.control.defaults().extend([
        new ol.control.OverviewMap(),
        new ol.control.FullScreen()
      ]),
      layers: [
        new ol.layer.Image({
          source: new ol.source.ImageStatic({
            attributions: [
              new ol.Attribution({
                html: '&copy; The Trustees of the British Museum'
              })
            ],
            url: task.info.url_b,
            projection: projection,
            imageExtent: extent
          })
        })
      ],
      target: 'map',
      view: new ol.View({
        projection: projection,
        center: ol.extent.getCenter(extent),
        zoom: 1.
        minZoom: 1,
        maxZoom: 5
      })

    });
      zoomslider = new ol.control.ZoomSlider();
      map.addControl(zoomslider);
    window.onresize = function()
    {
      setTimeout( function() { map.updateSize();}, 200);
    }

    }  else {
        deferred.resolve(task);
    }
});

</script>

<script>
pybossa.presentTask(function(task, deferred) {
    if ( !$.isEmptyObject(task) ) {
        loadUserProgress();
        $(':input','#transcription')
           .not(':button, :submit, :reset, :hidden, :radio')
           .val('')
           .removeAttr('checked')
           .removeAttr('selected');

      	$("a#raw").attr("href", task.info.url_b);
        $(".fancybox").fancybox();
        $('#imgLink').tooltip();
        $("[rel=tooltip]").tooltip();
        $("#question").html(task.info.question);
        $('#task-id').html(task.id);
        $("#map_" + task.id).show();
        $("#img_" + task.id).show();

        $('.btn-answer').off('click').on('click', function(evt) {
            evt.preventDefault();
            var answer = $(evt.target).attr("value");
            if (typeof answer !== 'undefined') {
                console.log(answer);
                if (answer === 'search') {
                    $("#searching").show();
                    search(task, $("#toSearch").val(), 15);
                } else {
                    task.answer = $("#transcription").serializeJSON();
                    console.log(task.answer);
                    console.log(task.answer);

                    pybossa.saveTask(task.id, task.answer).done(function() {
                        $("#map_" + task.id).hide();
                        $("#img_" + task.id).hide();
                        //$('#img_task_' + task.id).trigger('wheelzoom.reset');
                        $("html, body").animate({ scrollTop: 0 }, "slow");
                        $("#success").fadeIn(500).fadeOut(5500);
                        $("#loading").fadeIn(500).fadeOut(1000);
                        deferred.resolve();
                    });
                    $("#loading").fadeIn(500);

                }
            } else {
                console.log(answer);
                console.log(typeof(answer));
                $("#error").show();
            }
        });
        $("#loading").hide();
    }
    else {
        $(".skeleton").hide();
        $("#loading").hide();
        $("#finish").fadeIn(500);
    }
});
if(Modernizr.borderradius) {
    pybossa.run('wgs');
}
else {
    $(".skeleton").hide();
    $("#oldbrowser").show();
}
$(window).off('.affix');
$("#imgHolder")
    .removeClass("affix affix-top affix-bottom")
    .removeData("bs.affix");

</script>

<style>
    #map {
        background-color: black;
        height: 500px;
    }
    #map:-moz-full-screen {
        height: 100%;
    }
    #map:-webkit-full-screen {
        height: 100%;
    }
    #map:-ms-fullscreen {
        height: 100%;
    }
    #map:full-screen {
        height: 100%;
     }
     .ol-rotate {
        top: 3em;
     }
</style>